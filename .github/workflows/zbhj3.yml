name: Run items-hj3.py script automatically

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 7 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 安装依赖
      run: |
        pip install requests

    - name: 运行脚本并保存纯净输出
      id: run-script
      run: |
        echo "=== 运行脚本 ==="
        
        # 运行脚本，只捕获纯净输出
        echo "运行 set/items-hj3.py..."
        
        # 尝试运行脚本并捕获输出
        set +e
        SCRIPT_OUTPUT=$(python set/items-hj3.py 2>&1)
        EXIT_CODE=$?
        set -e
        
        echo "脚本退出码: $EXIT_CODE"
        
        # 检查输出是否是直播源格式（包含逗号和http）
        if echo "$SCRIPT_OUTPUT" | grep -q -E "^[^,]+,[^,]+$" && echo "$SCRIPT_OUTPUT" | grep -q "http"; then
          echo "检测到直播源格式的输出"
          echo "$SCRIPT_OUTPUT" > zby.txt
          echo "已将纯净输出保存到 zby.txt"
          echo "has_valid_output=true" >> $GITHUB_OUTPUT   
          echo "zby.txt 行数: $(wc -l < zby.txt)"
          echo "zby.txt 前5行:"
          head -5 zby.txt

    - name: 提交文件
      run: |
        echo "=== 提交文件 ==="
        
        # 配置Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 拉取最新
        git pull origin ${{ github.ref_name }} 2>/dev/null || true
        
        # 检查是否有更改
        if git diff --quiet zby.txt 2>/dev/null; then
          echo "文件无更改，创建空提交以确保文件存在"
          git commit --allow-empty -m "更新zby.txt [$(date +'%Y-%m-%d %H:%M:%S')]"
        else
          echo "检测到更改，正常提交"
          git add zby.txt
          git commit -m "更新zby.txt [$(date +'%Y-%m-%d %H:%M:%S')]"
        fi
        
        # 推送更改
        git push origin ${{ github.ref_name }}
        echo "✅ 文件已提交到仓库"

    - name: 显示最终结果
      run: |
        echo "=== 工作流执行结果 ==="
        echo "生成时间: $(date)"
        echo "使用有效输出: ${{ steps.run-script.outputs.has_valid_output }}"
        echo "文件行数: $(wc -l < zby.txt)"
        echo "文件前10行内容:"
        head -10 zby.txt
        echo "..."
