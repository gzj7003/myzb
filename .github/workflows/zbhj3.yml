name: Run items-hj3.py script automatically

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 7 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 安装依赖
      run: |
        echo "安装 requests 模块..."
        pip install requests
        echo "依赖安装完成"

    - name: 生成zby.txt文件
      run: |
        echo "=== 开始生成 zby.txt ==="
        echo "当前目录: $(pwd)"
        
        # 创建zby.txt文件
        echo "# zby.txt 文件" > zby.txt
        echo "# 生成时间: $(date '+%Y-%m-%d %H:%M:%S')" >> zby.txt
        echo "# =====================" >> zby.txt
        
        # 运行脚本并捕获输出
        echo "运行脚本: set/items-hj3.py"
        python_output=$(python set/items-hj3.py 2>&1)
        exit_code=$?
        
        echo "# 脚本退出码: $exit_code" >> zby.txt
        echo "# =====================" >> zby.txt
        
        if [ -n "$python_output" ]; then
          echo "# 脚本输出:" >> zby.txt
          echo "$python_output" >> zby.txt
        else
          echo "# 脚本没有输出" >> zby.txt
        fi
        
        echo "# =====================" >> zby.txt
        echo "# 文件生成完成" >> zby.txt
        
        echo "zby.txt已创建"
        echo "文件内容:"
        cat zby.txt
        echo "文件大小: $(wc -l < zby.txt) 行"

    - name: 强制提交文件
      run: |
        echo "=== 强制提交文件 ==="
        
        # 配置Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 添加文件
        git add zby.txt
        
        # 检查是否有更改
        if git diff --cached --quiet; then
          echo "没有更改，创建空提交以确保文件存在"
          git commit --allow-empty -m "更新zby.txt [$(date +'%Y-%m-%d %H:%M:%S')]"
        else
          echo "检测到更改，正常提交"
          git commit -m "更新zby.txt [$(date +'%Y-%m-%d %H:%M:%S')]"
        fi
        
        # 推送更改
        git push origin ${{ github.ref_name }}
        echo "✅ 文件已提交到仓库"

    - name: 验证文件已提交
      run: |
        echo "=== 验证文件 ==="
        echo "检查zby.txt是否存在:"
        ls -la zby.txt
        
        echo "文件内容:"
        cat zby.txt
        
        echo "文件状态:"
        git status zby.txt || echo "git状态检查失败"
        
        echo "✅ 工作流执行完成"
