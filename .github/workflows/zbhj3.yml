name: Run the items-hj3.py script automatically

on:
  # Timed trigger: 22:00 and 07:00 UTC every day (corresponding to 06:00 and 15:00 Beijing time)
  schedule:
    - cron: '0 22 * * *'  # 22:00 UTC every day (06:00 Beijing time the next day)
    - cron: '0 7 * * *'   # 07:00 UTC (15:00 Beijing time) every day

  # Allows manual triggering
  workflow_dispatch:

  # Runs when code pushes too (optional)
  push:
    branches: [ main, master ]

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        # Get the full history to be able to push back to the repository
        fetch-depth: 0

    - name: Set up the Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install requests

    - name: Run items-hj3.py script
      run: |
        echo "Current working directory: $(pwd)"
        echo "Contents of the directory:"
        ls -la
        echo "set directory contents:"
        ls -la set/

        # Run the Python script
        python set/items-hj3.py

        # Check if zby.txt file is generated
        echo "After running, directory content:"
        ls -la

        if [ -f "set/zby.txt" ] || [ -f "zby.txt" ]; then
          echo "File generation successful"
          
          # Make sure the file is in the root directory
          if [ -f "set/zby.txt" ]; then
            echo "Found zby.txt in the set directory, moving to root"
            mv set/zby.txt .
          fi
          
          # Check the file
          echo "File details:"
          ls -la zby.txt
          echo "First 10 lines of the file:"
          head -10 zby.txt || echo "File is empty or cannot be read"
        else
          echo "Error: zby.txt file was not generated"
          echo "Looking for all .txt files:"
          find . -name "*.txt" -type f
          exit 1
        fi

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Pull latest changes before committing
      run: |
        git pull origin ${{ github.ref_name }} --rebase || echo "Pull failed or no changes"

    - name: Submit the generated file
      run: |
        # Check if the file exists
        if [ ! -f "zby.txt" ]; then
          echo "Error: zby.txt file does not exist"
          exit 1
        fi
        
        # Check if the file has changed
        if git diff --quiet zby.txt; then
          echo "No changes in the file, no submission required"
        else
          echo "File changes detected, ready for submission"
          git add zby.txt
          git commit -m "Auto-update: items-hj3.py generated zby.txt file [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push origin HEAD
        fi
