name: Run items-hj3.py script automatically

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 7 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 直接生成zby.txt文件
      run: |
        echo "# 自动生成的zby.txt" > zby.txt
        echo "# 生成时间: $(date '+%Y-%m-%d %H:%M:%S')" >> zby.txt
        echo "# 脚本: set/items-hj3.py" >> zby.txt
        echo "# =====================" >> zby.txt
        
        # 尝试运行脚本，如果失败也无所谓
        echo "正在尝试运行脚本..." >> zby.txt
        echo "========================" >> zby.txt
        
        # 尝试运行脚本并将输出追加到文件
        python set/items-hj3.py 2>&1 >> zby.txt || echo "脚本执行失败或没有输出" >> zby.txt
        
        echo "========================" >> zby.txt
        echo "# 文件生成完成" >> zby.txt
        
        # 检查文件大小
        echo "zby.txt文件已生成，大小: $(wc -l < zby.txt) 行"

    - name: 提交文件
      run: |
        # 配置Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 拉取最新
        git pull origin ${{ github.ref_name }} 2>/dev/null || true
        
        # 检查是否有更改
        if git status --porcelain zby.txt | grep -q 'M'; then
          echo "文件有更改，提交..."
          git add zby.txt
          git commit -m "更新zby.txt [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push origin ${{ github.ref_name }}
          echo "✅ 文件已提交"
        else
          echo "文件无更改，跳过提交"
        fi
