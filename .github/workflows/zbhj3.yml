name: Run items-hj3.py script automatically

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 7 * * *'

  workflow_dispatch:

  push:
    branches: [ main, master ]

jobs:
  debug-script:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 分析脚本内容
      id: analyze-script
      run: |
        echo "=== 分析脚本内容 ==="
        
        if [ ! -f "set/items-hj3.py" ]; then
          echo "错误: 脚本文件不存在"
          exit 1
        fi
        
        # 显示脚本基本信息
        echo "脚本路径: set/items-hj3.py"
        echo "脚本大小: $(wc -l < set/items-hj3.py) 行"
        echo "脚本前50行:"
        head -50 set/items-hj3.py
        
        echo "=== 查找脚本中的文件写入操作 ==="
        echo "查找 'open(' 命令:"
        grep -n "open(" set/items-hj3.py || echo "未找到 open() 调用"
        
        echo "查找 '.write' 或 '.writelines':"
        grep -n "\.write\|\.writelines" set/items-hj3.py || echo "未找到写入方法"
        
        echo "查找 'print(' 调用:"
        grep -n "print(" set/items-hj3.py || echo "未找到 print() 调用"
        
        echo "查找 'zby.txt' 字符串:"
        grep -n "zby.txt" set/items-hj3.py || echo "未找到 'zby.txt' 字符串"
        
        echo "查找文件写入相关模式:"
        grep -n "with.*open\|\.write\|\.close\|file =" set/items-hj3.py || echo "未找到文件操作"
        
        # 分析脚本可能写入的目录
        echo "=== 分析可能的写入目录 ==="
        echo "查找目录操作:"
        grep -n "os\.\|path\.\|mkdir\|chdir" set/items-hj3.py || echo "未找到目录操作"

    - name: 运行脚本并监控文件系统
      id: run-monitored
      run: |
        echo "=== 运行脚本并监控文件系统变化 ==="
        
        # 记录运行前的文件状态
        echo "运行前文件列表:"
        find . -type f -not -path "./.git/*" 2>/dev/null | sort > /tmp/before.txt
        echo "运行前文件总数: $(wc -l < /tmp/before.txt)"
        
        # 记录运行前的zby.txt位置
        echo "运行前查找zby.txt:"
        find . -name "zby.txt" -type f 2>/dev/null || echo "运行前没有zby.txt"
        
        # 运行脚本，监控系统调用
        echo "开始运行脚本..."
        
        # 使用简单的Python代码来运行脚本并捕获输出
        python3 -c "
import subprocess
import sys

# 运行脚本并捕获所有输出
result = subprocess.run(
    [sys.executable, 'set/items-hj3.py'],
    capture_output=True,
    text=True,
    timeout=300
)

print('退出码:', result.returncode)
print('标准输出:')
print(result.stdout)
if result.stderr:
    print('标准错误:')
    print(result.stderr)
" 2>&1 | tee /tmp/script_run.txt
        
        # 记录运行后的文件状态
        echo "运行后文件列表:"
        find . -type f -not -path "./.git/*" 2>/dev/null | sort > /tmp/after.txt
        echo "运行后文件总数: $(wc -l < /tmp/after.txt)"
        
        # 查找新创建的文件
        echo "=== 新创建的文件 ==="
        comm -13 /tmp/before.txt /tmp/after.txt 2>/dev/null || echo "无法比较文件列表"
        
        # 查找修改的文件
        echo "=== 最近修改的文件 ==="
        find . -type f -not -path "./.git/*" -mmin -5 2>/dev/null || echo "没有最近修改的文件"
        
        # 记录脚本输出
        script_output=$(cat /tmp/script_run.txt)
        echo "SCRIPT_OUTPUT<<EOF" >> $GITHUB_OUTPUT
        echo "$script_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: 直接测试脚本执行
      id: test-script
      run: |
        echo "=== 直接测试脚本执行 ==="
        
        # 创建测试目录
        mkdir -p /tmp/test_run
        cd /tmp/test_run
        
        # 复制脚本
        cp -r ${{ github.workspace }}/set ./ 2>/dev/null || echo "无法复制set目录"
        
        echo "测试目录: $(pwd)"
        echo "目录内容:"
        ls -la
        
        # 直接运行脚本并查看输出
        echo "运行脚本:"
        python set/items-hj3.py 2>&1 | tee output.txt
        
        echo "运行后目录内容:"
        ls -la
        
        echo "所有文件:"
        find . -type f
        
        # 如果有输出文件，复制回工作区
        if [ -f "zby.txt" ]; then
          echo "在测试目录中找到zby.txt，复制回工作区"
          cp zby.txt ${{ github.workspace }}/
        fi

    - name: 模拟脚本可能的行为
      id: simulate-script
      run: |
        echo "=== 模拟脚本可能的行为 ==="
        
        # 检查脚本是否只是打印输出而不写入文件
        cd ${{ github.workspace }}
        
        echo "尝试直接执行脚本并将输出重定向到文件:"
        python set/items-hj3.py > simulated_zby.txt 2>&1
        
        if [ -s "simulated_zby.txt" ]; then
          echo "脚本有输出，已保存到 simulated_zby.txt"
          echo "文件内容预览:"
          head -20 simulated_zby.txt
          
          # 重命名为zby.txt
          mv simulated_zby.txt zby.txt
          echo "已将输出保存为 zby.txt"
        else
          echo "脚本没有输出内容"
          # 创建空的zby.txt
          echo "# 脚本执行完成但没有输出" > zby.txt
          echo "# 执行时间: $(date)" >> zby.txt
        fi

    - name: 最终检查并提交
      run: |
        echo "=== 最终检查 ==="
        cd ${{ github.workspace }}
        
        # 确保zby.txt存在
        if [ ! -f "zby.txt" ]; then
          echo "zby.txt不存在，创建空文件"
          echo "# 自动生成 - 原始脚本未产生输出" > zby.txt
          echo "# 生成时间: $(date)" >> zby.txt
        fi
        
        echo "文件内容:"
        cat zby.txt
        
        # 配置Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 拉取最新更改
        git pull origin ${{ github.ref_name }} --no-rebase 2>/dev/null || echo "拉取失败或无需拉取"
        
        # 添加并提交
        git add zby.txt
        git commit -m "更新: items-hj3.py运行结果 [$(date +'%Y-%m-%d %H:%M:%S')]" || echo "没有更改或提交失败"
        
        # 推送
        git push origin ${{ github.ref_name }} 2>/dev/null || echo "推送失败或无需推送"

    - name: 生成分析报告
      run: |
        echo "=== 分析报告 ==="
        echo "脚本分析完成"
        echo "脚本输出:"
        echo "${{ steps.run-monitored.outputs.SCRIPT_OUTPUT }}" | head -30
        echo "..."
        
        echo "最终状态:"
        if [ -f "${{ github.workspace }}/zby.txt" ]; then
          echo "✅ zby.txt 已创建"
          echo "文件大小: $(wc -l < ${{ github.workspace }}/zby.txt) 行"
        else
          echo "❌ zby.txt 未创建"
        fi
