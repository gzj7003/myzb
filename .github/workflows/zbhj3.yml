name: Run items-hj3.py script automatically

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 7 * * *'

  workflow_dispatch:

  push:
    branches: [ main, master ]

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        echo "=== 安装依赖 ==="
        pip install requests
        echo "依赖安装完成"

    - name: 调试 - 查看脚本内容和环境
      run: |
        echo "=== 调试信息 ==="
        echo "工作目录: $(pwd)"
        echo "Python版本: $(python --version)"
        
        echo "=== 检查脚本文件 ==="
        if [ -f "set/items-hj3.py" ]; then
          echo "脚本存在: set/items-hj3.py"
          echo "脚本大小: $(wc -l < set/items-hj3.py) 行"
          echo "脚本前20行:"
          head -20 set/items-hj3.py
        else
          echo "错误: 找不到 set/items-hj3.py"
          echo "当前目录内容:"
          ls -la
          echo "set目录内容:"
          ls -la set/ 2>/dev/null || echo "没有set目录"
          exit 1
        fi
        
        echo "=== 检查Python模块 ==="
        python -c "import sys; print('Python路径:', sys.path)"
        python -c "import requests; print('requests模块已安装')" || echo "requests模块未安装"

    - name: 运行脚本并捕获详细错误
      id: run-script
      run: |
        echo "=== 运行脚本并捕获详细错误 ==="
        cd ${{ github.workspace }}
        
        # 创建临时文件来捕获输出
        TEMP_OUTPUT="/tmp/script_output_$(date +%s).txt"
        
        echo "开始运行脚本: set/items-hj3.py"
        echo "================================"
        
        # 使用更详细的错误捕获
        set +e  # 禁用错误立即退出
        python set/items-hj3.py > "$TEMP_OUTPUT" 2>&1
        EXIT_CODE=$?
        set -e  # 重新启用错误立即退出
        
        echo "脚本退出码: $EXIT_CODE"
        echo "================================"
        
        # 显示输出
        echo "脚本输出:"
        cat "$TEMP_OUTPUT" || echo "无法读取输出文件"
        echo "================================"
        
        # 保存输出到环境变量
        echo "SCRIPT_OUTPUT<<EOF" >> $GITHUB_OUTPUT
        cat "$TEMP_OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # 根据退出码决定是否继续
        if [ $EXIT_CODE -eq 0 ]; then
          echo "脚本执行成功"
          
          # 检查是否生成了zby.txt
          if [ -f "set/zby.txt" ]; then
            echo "在set目录中找到zby.txt"
            mv set/zby.txt .
            echo "已将set/zby.txt移动到根目录"
          elif [ -f "zby.txt" ]; then
            echo "在根目录中找到zby.txt"
          else
            echo "警告: 脚本执行成功但未生成zby.txt"
            # 将脚本输出保存为zby.txt
            cp "$TEMP_OUTPUT" zby.txt
            echo "已将脚本输出保存为zby.txt"
          fi
        else
          echo "脚本执行失败，退出码: $EXIT_CODE"
          echo "将错误信息保存为zby.txt以便调试"
          
          # 创建包含错误信息的zby.txt
          echo "# 脚本执行失败 - 错误信息" > zby.txt
          echo "# 退出码: $EXIT_CODE" >> zby.txt
          echo "# 时间: $(date)" >> zby.txt
          echo "# 错误输出:" >> zby.txt
          cat "$TEMP_OUTPUT" >> zby.txt
          
          echo "已将错误信息保存到zby.txt"
        fi
        
        # 确保zby.txt存在
        if [ ! -f "zby.txt" ]; then
          echo "创建空的zby.txt文件"
          echo "# 脚本执行完成" > zby.txt
          echo "# 时间: $(date)" >> zby.txt
        fi

    - name: 检查并提交结果
      run: |
        echo "=== 检查并提交结果 ==="
        cd ${{ github.workspace }}
        
        # 确保zby.txt存在
        if [ ! -f "zby.txt" ]; then
          echo "错误: zby.txt不存在"
          exit 1
        fi
        
        echo "zby.txt文件信息:"
        ls -la zby.txt
        echo "文件前10行:"
        head -10 zby.txt || echo "文件为空"
        
        # 配置Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 拉取最新更改
        echo "拉取最新更改..."
        git pull origin ${{ github.ref_name }} --no-rebase 2>/dev/null || echo "拉取失败或无需拉取"
        
        # 检查是否有更改
        echo "检查文件更改..."
        if git diff --quiet zby.txt 2>/dev/null; then
          echo "文件无更改，无需提交"
        else
          echo "检测到文件更改，准备提交"
          
          # 添加并提交
          git add zby.txt
          
          # 根据脚本执行状态设置提交信息
          if [ "${{ steps.run-script.outputs.EXIT_CODE }}" == "0" ]; then
            commit_msg="自动更新: 脚本执行成功 [$(date +'%Y-%m-%d %H:%M:%S')]"
          else
            commit_msg="自动更新: 脚本执行失败，已记录错误 [$(date +'%Y-%m-%d %H:%M:%S')]"
          fi
          
          git commit -m "$commit_msg"
          
          # 推送
          echo "推送更改..."
          git push origin ${{ github.ref_name }}
        fi

    - name: 工作流总结
      run: |
        echo "=== 工作流执行总结 ==="
        echo "执行时间: $(date)"
        echo "触发事件: ${{ github.event_name }}"
        echo "分支: ${{ github.ref_name }}"
        
        if [ -f "${{ github.workspace }}/zby.txt" ]; then
          echo "✅ zby.txt 已创建"
          echo "文件大小: $(wc -l < ${{ github.workspace }}/zby.txt) 行"
          echo "前3行内容:"
          head -3 ${{ github.workspace }}/zby.txt
        else
          echo "❌ zby.txt 未创建"
        fi
        
        echo "脚本输出 (前20行):"
        echo "${{ steps.run-script.outputs.SCRIPT_OUTPUT }}" | head -20
