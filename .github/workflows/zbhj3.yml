name: Run items-hj3.py script automatically

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 7 * * *'

  workflow_dispatch:

  push:
    branches: [ main, master ]

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        echo "=== 安装依赖 ==="
        pip install requests
        echo "依赖安装完成"

    - name: Debug - 检查脚本内容
      run: |
        echo "=== 调试: 检查脚本内容 ==="
        if [ -f "set/items-hj3.py" ]; then
          echo "脚本路径: set/items-hj3.py"
          echo "脚本大小: $(wc -l < set/items-hj3.py) 行"
          echo "前30行脚本内容:"
          head -30 set/items-hj3.py || echo "无法读取脚本"
        else
          echo "错误: 找不到 set/items-hj3.py"
          echo "当前目录结构:"
          find . -type f -name "*.py" | head -20
          exit 1
        fi

    - name: Debug - 检查Python环境
      run: |
        echo "=== 调试: Python环境 ==="
        python --version
        pip --version
        echo "Python路径: $(which python)"
        echo "当前工作目录: $(pwd)"

    - name: Debug - 设置目录详细检查
      run: |
        echo "=== 调试: set目录详细检查 ==="
        if [ -d "set" ]; then
          echo "set目录存在"
          echo "set目录内容:"
          ls -la set/
          echo "set目录中的所有文件:"
          find set/ -type f | head -20
        else
          echo "错误: set目录不存在"
          exit 1
        fi

    - name: Run items-hj3.py script (详细调试)
      id: run-script
      run: |
        echo "=== 执行脚本 (详细模式) ==="
        
        # 检查脚本是否可执行
        if [ ! -f "set/items-hj3.py" ]; then
          echo "错误: set/items-hj3.py 不存在"
          exit 1
        fi
        
        echo "脚本权限:"
        ls -la set/items-hj3.py
        
        echo "执行前set目录内容:"
        ls -la set/ 2>/dev/null || echo "无法访问set目录"
        
        echo "执行前根目录内容:"
        ls -la *.txt 2>/dev/null || echo "没有txt文件"
        
        # 创建临时目录用于监控
        mkdir -p /tmp/debug_script
        echo "开始执行脚本..."
        
        # 使用tee同时输出到控制台和文件
        # 设置超时，避免脚本无限运行
        timeout 300 python set/items-hj3.py 2>&1 | tee /tmp/script_output.txt
        
        script_exit_code=${PIPESTATUS[0]}
        echo "脚本退出代码: $script_exit_code"
        
        if [ $script_exit_code -eq 124 ]; then
          echo "错误: 脚本执行超时 (5分钟)"
        elif [ $script_exit_code -ne 0 ]; then
          echo "错误: 脚本执行失败，退出代码: $script_exit_code"
        else
          echo "脚本执行完成"
        fi
        
        echo "=== 脚本输出 ==="
        cat /tmp/script_output.txt || echo "无输出"
        
        echo "执行后set目录内容:"
        ls -la set/ 2>/dev/null || echo "无法访问set目录"
        
        echo "执行后根目录内容:"
        ls -la *.txt 2>/dev/null || echo "没有txt文件"
        
        # 检查是否有任何新文件生成
        echo "所有txt文件:"
        find . -name "*.txt" -type f 2>/dev/null || echo "没有找到txt文件"
        
        # 保存脚本输出到环境变量
        echo "SCRIPT_OUTPUT<<EOF" >> $GITHUB_OUTPUT
        cat /tmp/script_output.txt | head -1000 >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # 如果脚本失败，退出
        if [ $script_exit_code -ne 0 ] && [ $script_exit_code -ne 124 ]; then
          exit $script_exit_code
        fi

    - name: Debug - 搜索生成的文件
      run: |
        echo "=== 调试: 搜索所有文件变化 ==="
        
        echo "当前时间: $(date)"
        echo "工作空间根目录: $(pwd)"
        
        echo "所有文件列表 (前50个):"
        find . -type f -not -path "./.git/*" | head -50
        
        echo "最近修改的文件:"
        find . -type f -not -path "./.git/*" -mmin -10 2>/dev/null | head -20 || echo "无法找到最近修改的文件"
        
        echo "所有.txt文件:"
        find . -name "*.txt" -type f 2>/dev/null
        
        echo "所有.csv文件:"
        find . -name "*.csv" -type f 2>/dev/null
        
        echo "所有.json文件:"
        find . -name "*.json" -type f 2>/dev/null
        
        echo "所有数据文件:"
        find . -type f \( -name "*.txt" -o -name "*.csv" -o -name "*.json" -o -name "*.xlsx" -o -name "*.xls" \) 2>/dev/null
        
        # 检查set目录详细内容
        echo "set目录完整内容:"
        if [ -d "set" ]; then
          find set/ -type f
        fi

    - name: 创建测试文件 (如果脚本没有生成)
      id: create-test-file
      run: |
        echo "=== 创建测试文件 ==="
        
        # 检查是否有任何输出文件
        txt_files=$(find . -name "*.txt" -type f 2>/dev/null | wc -l)
        
        if [ "$txt_files" -eq "0" ]; then
          echo "警告: 没有找到任何txt文件，创建测试文件"
          
          # 创建测试文件
          echo "# 这是测试文件" > zby.txt
          echo "# 生成时间: $(date)" >> zby.txt
          echo "# 原始脚本似乎没有生成文件" >> zby.txt
          echo "测试数据: 123" >> zby.txt
          
          echo "created_test_file=true" >> $GITHUB_OUTPUT
        else
          echo "找到 $txt_files 个txt文件"
          echo "created_test_file=false" >> $GITHUB_OUTPUT
          
          # 将找到的第一个txt文件复制为zby.txt
          first_txt=$(find . -name "*.txt" -type f 2>/dev/null | head -1)
          if [ -n "$first_txt" ] && [ "$first_txt" != "./zby.txt" ]; then
            echo "使用第一个找到的txt文件: $first_txt"
            cp "$first_txt" zby.txt 2>/dev/null || echo "无法复制文件"
          fi
        fi

    - name: 检查最终文件
      run: |
        echo "=== 检查最终文件 ==="
        
        if [ -f "zby.txt" ]; then
          echo "找到 zby.txt"
          echo "文件大小: $(wc -l < zby.txt) 行"
          echo "文件内容预览:"
          head -10 zby.txt || echo "无法读取文件"
        else
          echo "警告: zby.txt 不存在"
          echo "创建空的zby.txt"
          echo "# 空文件 - 脚本没有生成数据" > zby.txt
          echo "# 生成时间: $(date)" >> zby.txt
        fi

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Pull latest changes
      run: |
        echo "拉取最新更改..."
        git fetch origin
        git checkout ${{ github.ref_name }}
        git pull origin ${{ github.ref_name }} --no-rebase || echo "拉取完成（可能有冲突或无更改）"

    - name: Commit and push changes
      id: commit
      run: |
        echo "=== 提交更改 ==="
        
        # 确保文件存在
        if [ ! -f "zby.txt" ]; then
          echo "错误: zby.txt 不存在"
          exit 1
        fi
        
        # 显示文件状态
        echo "文件状态:"
        git status zby.txt || echo "git status 失败"
        
        # 检查是否有更改
        if git diff --quiet zby.txt 2>/dev/null; then
          echo "文件无更改"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "检测到文件更改"
          
          echo "更改预览:"
          git diff --stat zby.txt 2>/dev/null || echo "无法显示差异"
          
          # 添加并提交
          git add zby.txt
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            commit_msg="手动更新: 运行 items-hj3.py [$(date +'%Y-%m-%d %H:%M:%S')]"
          else
            commit_msg="自动更新: items-hj3.py 运行结果 [$(date +'%Y-%m-%d %H:%M:%S')]"
          fi
          
          git commit -m "$commit_msg"
          echo "提交信息: $commit_msg"
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Push changes
      if: steps.commit.outputs.has_changes == 'true'
      run: |
        echo "推送更改..."
        
        # 尝试推送，最多重试3次
        for i in {1..3}; do
          echo "推送尝试 $i/3"
          if git push origin HEAD:${{ github.ref_name }}; then
            echo "推送成功"
            break
          else
            echo "推送失败"
            if [ $i -lt 3 ]; then
              echo "等待5秒后重试..."
              sleep 5
              git pull origin ${{ github.ref_name }}
            else
              echo "错误: 推送失败3次"
              exit 1
            fi
          fi
        done

    - name: 工作流总结
      run: |
        echo "=== 工作流执行总结 ==="
        echo "执行时间: $(date)"
        echo "触发事件: ${{ github.event_name }}"
        echo "分支: ${{ github.ref_name }}"
        
        if [ -f "zby.txt" ]; then
          echo "最终文件: zby.txt"
          echo "文件行数: $(wc -l < zby.txt)"
          echo "文件大小: $(wc -c < zby.txt) 字节"
          
          if [ "${{ steps.create-test-file.outputs.created_test_file }}" == "true" ]; then
            echo "状态: 脚本未生成文件，已创建测试文件"
          else
            echo "状态: 脚本生成文件成功"
          fi
        else
          echo "状态: 失败 - 没有生成文件"
        fi
        
        echo "脚本输出 (前10行):"
        echo "${{ steps.run-script.outputs.SCRIPT_OUTPUT }}" | head -10
