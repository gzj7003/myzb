name: Run items-hj3.py script automatically

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 7 * * *'

  workflow_dispatch:

  push:
    branches: [ main, master ]

jobs:
  debug-script:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 分析脚本内容
      id: analyze-script
      run: |
        echo "=== 分析脚本内容 ==="
        
        if [ ! -f "set/items-hj3.py" ]; then
          echo "错误: 脚本文件不存在"
          exit 1
        fi
        
        # 显示脚本基本信息
        echo "脚本路径: set/items-hj3.py"
        echo "脚本大小: $(wc -l < set/items-hj3.py) 行"
        echo "脚本前50行:"
        head -50 set/items-hj3.py
        
        echo "=== 查找脚本中的文件写入操作 ==="
        echo "查找 'open(' 命令:"
        grep -n "open(" set/items-hj3.py || echo "未找到 open() 调用"
        
        echo "查找 '.write' 或 '.writelines':"
        grep -n "\.write\|\.writelines" set/items-hj3.py || echo "未找到写入方法"
        
        echo "查找 'print(' 调用:"
        grep -n "print(" set/items-hj3.py || echo "未找到 print() 调用"
        
        echo "查找 'zby.txt' 字符串:"
        grep -n "zby.txt" set/items-hj3.py || echo "未找到 'zby.txt' 字符串"
        
        echo "查找文件写入相关模式:"
        grep -n "with.*open\|\.write\|\.close\|file =" set/items-hj3.py || echo "未找到文件操作"
        
        # 分析脚本可能写入的目录
        echo "=== 分析可能的写入目录 ==="
        echo "查找目录操作:"
        grep -n "os\.\|path\.\|mkdir\|chdir" set/items-hj3.py || echo "未找到目录操作"

    - name: 简单运行脚本并检查输出
      id: simple-run
      run: |
        echo "=== 简单运行脚本并检查输出 ==="
        cd ${{ github.workspace }}
        
        # 运行脚本并捕获输出
        echo "运行脚本: set/items-hj3.py"
        python_output=$(python set/items-hj3.py 2>&1)
        exit_code=$?
        
        echo "脚本退出码: $exit_code"
        echo "脚本输出长度: ${#python_output} 字符"
        
        # 保存输出到临时文件用于调试
        echo "$python_output" > /tmp/script_output.txt
        
        # 检查是否生成了zby.txt
        echo "检查是否生成了zby.txt..."
        if [ -f "set/zby.txt" ]; then
          echo "在set目录中找到zby.txt"
          mv set/zby.txt .
          echo "已将set/zby.txt移动到根目录"
        elif [ -f "zby.txt" ]; then
          echo "在根目录中找到zby.txt"
        else
          echo "未找到zby.txt文件"
          
          # 检查脚本是否有输出
          if [ -n "$python_output" ]; then
            echo "脚本有输出，将输出保存为zby.txt"
            echo "$python_output" > zby.txt
            echo "已将脚本输出保存到zby.txt"
          else
            echo "脚本没有输出，创建空zby.txt文件"
            echo "# 脚本执行完成但没有输出" > zby.txt
            echo "# 执行时间: $(date)" >> zby.txt
          fi
        fi
        
        # 确保zby.txt存在
        if [ ! -f "zby.txt" ]; then
          echo "错误: zby.txt未创建"
          exit 1
        fi
        
        echo "zby.txt文件信息:"
        ls -la zby.txt
        echo "文件内容预览:"
        head -5 zby.txt || echo "文件为空或无法读取"

    - name: 最终检查并提交
      run: |
        echo "=== 最终检查并提交 ==="
        cd ${{ github.workspace }}
        
        # 确保zby.txt存在
        if [ ! -f "zby.txt" ]; then
          echo "错误: zby.txt不存在"
          exit 1
        fi
        
        # 检查文件是否为空
        if [ ! -s "zby.txt" ]; then
          echo "警告: zby.txt文件为空，添加时间戳"
          echo "# 更新时间: $(date)" >> zby.txt
        fi
        
        echo "最终文件内容:"
        cat zby.txt
        
        # 配置Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 拉取最新更改
        echo "拉取最新更改..."
        git pull origin ${{ github.ref_name }} --no-rebase 2>/dev/null || echo "拉取失败或无需拉取"
        
        # 检查是否有更改
        echo "检查文件更改..."
        if git diff --quiet zby.txt 2>/dev/null; then
          echo "文件无更改，无需提交"
        else
          echo "检测到文件更改，准备提交"
          
          # 显示更改
          echo "更改内容:"
          git diff zby.txt || echo "无法显示差异"
          
          # 添加并提交
          git add zby.txt
          git commit -m "自动更新: items-hj3.py运行结果 [$(date +'%Y-%m-%d %H:%M:%S')]"
          
          # 推送
          echo "推送更改..."
          git push origin ${{ github.ref_name }}
        fi

    - name: 工作流总结
      run: |
        echo "=== 工作流执行总结 ==="
        echo "执行时间: $(date)"
        echo "触发事件: ${{ github.event_name }}"
        echo "分支: ${{ github.ref_name }}"
        
        if [ -f "${{ github.workspace }}/zby.txt" ]; then
          echo "✅ zby.txt 已创建并提交"
          echo "文件大小: $(wc -l < ${{ github.workspace }}/zby.txt) 行"
        else
          echo "❌ zby.txt 未创建"
        fi
