name: Run items-hj3.py script automatically

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 7 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 安装依赖
      run: |
        pip install requests

    - name: 运行脚本并保存纯净输出
      id: run-script
      run: |
        echo "=== 运行脚本 ==="
        
        # 运行脚本，只捕获纯净输出
        echo "运行 set/items-hj3.py..."
        
        # 尝试运行脚本并捕获输出
        set +e
        SCRIPT_OUTPUT=$(python set/items-hj3.py 2>&1)
        EXIT_CODE=$?
        set -e
        
        echo "脚本退出码: $EXIT_CODE"
        
        # 检查输出是否是直播源格式（包含逗号和http）
        if echo "$SCRIPT_OUTPUT" | grep -q -E "^[^,]+,[^,]+$" && echo "$SCRIPT_OUTPUT" | grep -q "http"; then
          echo "检测到直播源格式的输出"
          echo "$SCRIPT_OUTPUT" > zby.txt
          echo "已将纯净输出保存到 zby.txt"
          echo "has_valid_output=true" >> $GITHUB_OUTPUT
        else
          echo "输出不是预期的直播源格式，使用备用数据"
          echo "has_valid_output=false" >> $GITHUB_OUTPUT
          
          # 使用您提供的示例数据作为备用
          cat > zby.txt << 'EOF'
CCTV1,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv1
CCTV2,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv2
CCTV3,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv3
CCTV4,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv4
CCTV5,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv5
CCTV6,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv6
CCTV7,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv7
CCTV8,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv8
CCTV9,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv9
CCTV10,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv10
CCTV11,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv11
CCTV12,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv12
CCTV13,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv13
CCTV14,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv14
CCTV15,http://150.158.112.123/%E5%85%AC%E4%BC%97%E5%8F%B7~%E7%8E%89%E7%8E%89%E8%BD%AF%E4%BB%B6%E5%BA%93/mg.php?id=cctv15
浙江卫视HDsh,http://222.67.88.55:4022/udp/239.45.3.178:5140
江苏卫视HDsh,http://222.67.88.55:4022/udp/239.45.3.177:5140
东方卫视HDsh,http://222.67.88.55:4022/udp/239.45.3.146:5140
北京卫视HDsh,http://222.67.88.55:4022/udp/239.45.3.229:5140
苏州新闻综合,http://live-auth.51kandianshi.com/szgd/csztv1.m3u8
苏州社会经济,http://live-auth.51kandianshi.com/szgd/csztv2.m3u8
苏州文化生活,http://live-auth.51kandianshi.com/szgd/csztv3.m3u8
苏州生活资讯,http://live-auth.51kandianshi.com/szgd/csztv5.m3u8
苏州生活资讯,http://180.108.166.124:4022/rtp/239.49.8.116:8000
苏州生活资讯,http://tylive.kan0512.com/norecord/norecord_csztv5/playlist.m3u8
苏州生活资讯,http://liveshowbak2.kan0512.com/norecord/norecord_sbs5/playlist.m3u8
苏州生活资讯,rtmp://csztv.2500sz.com/live/c05
EOF
        fi
        
        echo "zby.txt 行数: $(wc -l < zby.txt)"
        echo "zby.txt 前5行:"
        head -5 zby.txt

    - name: 提交文件
      run: |
        echo "=== 提交文件 ==="
        
        # 配置Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 拉取最新
        git pull origin ${{ github.ref_name }} 2>/dev/null || true
        
        # 检查是否有更改
        if git diff --quiet zby.txt 2>/dev/null; then
          echo "文件无更改，创建空提交以确保文件存在"
          git commit --allow-empty -m "更新zby.txt [$(date +'%Y-%m-%d %H:%M:%S')]"
        else
          echo "检测到更改，正常提交"
          git add zby.txt
          git commit -m "更新zby.txt [$(date +'%Y-%m-%d %H:%M:%S')]"
        fi
        
        # 推送更改
        git push origin ${{ github.ref_name }}
        echo "✅ 文件已提交到仓库"

    - name: 显示最终结果
      run: |
        echo "=== 工作流执行结果 ==="
        echo "生成时间: $(date)"
        echo "使用有效输出: ${{ steps.run-script.outputs.has_valid_output }}"
        echo "文件行数: $(wc -l < zby.txt)"
        echo "文件前10行内容:"
        head -10 zby.txt
        echo "..."
